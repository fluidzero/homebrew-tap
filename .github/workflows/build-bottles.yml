name: Build Homebrew Bottles

on:
  push:
    branches: [main]
    paths: ["Formula/**"]
  workflow_dispatch:

jobs:
  bottle:
    strategy:
      matrix:
        os: [macos-15, macos-14, macos-13, ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Install formula from source
        run: |
          brew install --build-from-source Formula/fz.rb

      - name: Create bottle
        run: |
          brew bottle --json --root-url="https://github.com/fluidzero/homebrew-tap/releases/download/bottles" Formula/fz.rb
          # Rename to standard bottle name (remove double-dash)
          for f in fz--*.bottle.*; do
            mv "$f" "$(echo "$f" | sed 's/fz--/fz-/')"
          done

      - name: Upload bottle artifact
        uses: actions/upload-artifact@v4
        with:
          name: bottle-${{ matrix.os }}
          path: |
            fz-*.bottle.*
            *.json

  upload:
    needs: bottle
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all bottle artifacts
        uses: actions/download-artifact@v4
        with:
          path: bottles/
          merge-multiple: true

      - name: Upload bottles to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create or update the bottles release
          gh release create bottles --title "Bottles" --notes "Prebuilt bottles for Homebrew" --repo ${{ github.repository }} 2>/dev/null || true
          # Delete old bottles for this version before uploading
          for f in bottles/fz-*.bottle.*; do
            fname=$(basename "$f")
            gh release delete-asset bottles "$fname" --repo ${{ github.repository }} --yes 2>/dev/null || true
          done
          # Upload new bottles
          gh release upload bottles bottles/fz-*.bottle.* --repo ${{ github.repository }} --clobber

      - name: Merge bottle JSON into formula
        run: |
          # Collect all JSON files
          cat bottles/*.json | python3 -c "
          import json, sys, re

          bottles = {}
          for line in sys.stdin:
              data = json.loads(line.strip()) if line.strip() else {}
              for formula, info in data.items():
                  bottle = info.get('bottle', {}).get('tags', {})
                  bottles.update(bottle)

          # Build the bottle block
          root_url = 'https://github.com/fluidzero/homebrew-tap/releases/download/bottles'
          lines = ['  bottle do']
          lines.append(f'    root_url \"{root_url}\"')
          for tag, info in sorted(bottles.items()):
              sha = info['sha256']
              lines.append(f'    sha256 cellar: :any_skip_relocation, {tag}: \"{sha}\"')
          lines.append('  end')
          print('\n'.join(lines))
          " > /tmp/bottle_block.txt

          echo "Generated bottle block:"
          cat /tmp/bottle_block.txt

      - name: Update formula with bottle block
        run: |
          BOTTLE_BLOCK=$(cat /tmp/bottle_block.txt)

          # Read current formula
          FORMULA="Formula/fz.rb"

          # Check if bottle block already exists
          if grep -q 'bottle do' "$FORMULA"; then
            # Replace existing bottle block
            python3 -c "
          import re
          with open('$FORMULA') as f:
              content = f.read()
          block = open('/tmp/bottle_block.txt').read()
          content = re.sub(r'  bottle do.*?  end\n', block + '\n', content, flags=re.DOTALL)
          with open('$FORMULA', 'w') as f:
              f.write(content)
          "
          else
            # Insert after license line
            python3 -c "
          with open('$FORMULA') as f:
              content = f.read()
          block = open('/tmp/bottle_block.txt').read()
          content = content.replace('  license \"Apache-2.0\"', '  license \"Apache-2.0\"\n\n' + block)
          with open('$FORMULA', 'w') as f:
              f.write(content)
          "
          fi

          echo "Updated formula:"
          cat "$FORMULA"

      - name: Commit updated formula
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/fz.rb
          git diff --cached --quiet && echo "No changes" || git commit -m "Add bottles for fz $(grep 'sha256' Formula/fz.rb | head -1 | grep -o 'v[0-9.]*' || echo '')" && git push
