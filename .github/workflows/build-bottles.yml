name: Build Homebrew Bottles

on:
  push:
    branches: [main]
    paths: ["Formula/**"]
  workflow_dispatch:

jobs:
  bottle:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-15, macos-14]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Tap and install formula from source
        run: |
          # Link this checkout as the tap so Homebrew recognizes it
          TAP_DIR="$(brew --repository)/Library/Taps/fluidzero/homebrew-tap"
          mkdir -p "$(dirname "$TAP_DIR")"
          ln -sf "$GITHUB_WORKSPACE" "$TAP_DIR"
          brew install --build-bottle --build-from-source fluidzero/tap/fz

      - name: Create bottle
        run: |
          brew bottle --json --root-url="https://github.com/fluidzero/homebrew-tap/releases/download/bottles" fluidzero/tap/fz

      - name: Upload bottle artifact
        uses: actions/upload-artifact@v4
        with:
          name: bottle-${{ matrix.os }}
          path: |
            fz--*.bottle.*
            *.json

  upload:
    needs: bottle
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all bottle artifacts
        uses: actions/download-artifact@v4
        with:
          path: bottles/
          merge-multiple: true

      - name: List downloaded artifacts
        run: ls -la bottles/

      - name: Upload bottles to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create the bottles release if it doesn't exist
          gh release create bottles --title "Bottles" --notes "Prebuilt bottles for Homebrew" --repo ${{ github.repository }} 2>/dev/null || true
          # Upload bottles (--clobber overwrites existing)
          gh release upload bottles bottles/fz--*.bottle.* --repo ${{ github.repository }} --clobber

      - name: Generate bottle block and update formula
        run: |
          python3 << 'PYEOF'
          import json, glob, re

          bottles = {}
          for jf in glob.glob("bottles/*.json"):
              with open(jf) as f:
                  data = json.load(f)
              for formula, info in data.items():
                  tags = info.get("bottle", {}).get("tags", {})
                  bottles.update(tags)

          if not bottles:
              print("No bottles found!")
              exit(1)

          root_url = "https://github.com/fluidzero/homebrew-tap/releases/download/bottles"
          lines = ["  bottle do", f'    root_url "{root_url}"']
          for tag in sorted(bottles):
              sha = bottles[tag]["sha256"]
              lines.append(f'    sha256 cellar: :any_skip_relocation, {tag}: "{sha}"')
          lines.append("  end")
          block = "\n".join(lines)
          print("Generated bottle block:")
          print(block)

          with open("Formula/fz.rb") as f:
              content = f.read()

          if "bottle do" in content:
              content = re.sub(r"  bottle do.*?  end", block, content, flags=re.DOTALL)
          else:
              content = content.replace(
                  '  license "Apache-2.0"',
                  '  license "Apache-2.0"\n\n' + block,
              )

          with open("Formula/fz.rb", "w") as f:
              f.write(content)
          print("\nUpdated formula written.")
          PYEOF

      - name: Commit updated formula
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/fz.rb
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update bottles for fz v0.1.1"
            git push
          fi
